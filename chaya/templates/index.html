<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Temperature Dashboard</title>
    <style>
        /* CSS styles are unchanged */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        :root {
            --bg-color: #f4f7f9; --card-bg: #ffffff; --text-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.08); --border-color: #eef2f5;
            --cold-color: #3498db; --normal-color: #2ecc71;
            --warm-color: #f39c12; --hot-color: #e74c3c;
        }
        body {
            font-family: 'Roboto', sans-serif; background-color: var(--bg-color);
            display: grid; place-items: center; height: 100vh; margin: 0; color: var(--text-color);
        }
        .dashboard-card {
            background-color: var(--card-bg); border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-color); padding: 40px;
            width: 320px; text-align: center; border: 1px solid var(--border-color);
        }
        h1 { font-weight: 700; font-size: 1.5rem; margin-top: 0; margin-bottom: 20px; }
        .gauge-container { position: relative; width: 200px; height: 200px; margin: 20px auto; }
        .gauge-background {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(var(--cold-color) 0deg 90deg, var(--normal-color) 90deg 180deg, var(--warm-color) 180deg 270deg, var(--hot-color) 270deg 360deg);
            filter: blur(10px) opacity(0.3);
        }
        .gauge-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 160px; height: 160px; background-color: var(--card-bg);
            border-radius: 50%; display: grid; place-items: center;
            box-shadow: inset 0 0 20px var(--shadow-color);
        }
        #temp-value { font-size: 4rem; font-weight: 700; transition: color 0.5s ease; }
        .temp-unit { font-size: 1.5rem; font-weight: 300; color: #777; }
        .status-text { font-size: 1rem; color: #888; margin-top: 20px; height: 20px; }
    </style>
</head>
<body>
    <div class="dashboard-card">
        <h1>üå°Ô∏è Live Sensor Reading</h1>
        <div class="gauge-container">
            <div class="gauge-background"></div>
            <div class="gauge-center">
                <div>
                    <span id="temp-value">--</span>
                    <span class="temp-unit">¬∞C</span>
                </div>
            </div>
        </div>
        <p class="status-text" id="status-text">Connecting...</p>
    </div>

    <script>
        const tempValueElement = document.getElementById('temp-value');
        const statusTextElement = document.getElementById('status-text');
        
        // NEW: Variable to hold our interval timer
        let fetchDataInterval;

        function updateUI(temp) {
            tempValueElement.innerText = temp;
            let status = 'Normal';
            let color = 'var(--normal-color)';
            if (temp < 15) { status = 'Cold'; color = 'var(--cold-color)'; }
            else if (temp >= 15 && temp < 28) { status = 'Normal'; color = 'var(--normal-color)'; }
            else if (temp >= 28 && temp < 35) { status = 'Warm'; color = 'var(--warm-color)'; }
            else { status = 'Hot'; color = 'var(--hot-color)'; }
            tempValueElement.style.color = color;
            if (fetchDataInterval) { // Only update status text if timer is active
                statusTextElement.innerText = status;
            }
        }

        async function fetchData() {
            try {
                const response = await fetch('/get_temp');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                const temp = parseFloat(data.temperature);
                if (!isNaN(temp)) {
                    updateUI(temp);
                } else {
                    statusTextElement.innerText = 'Waiting for valid data...';
                }
            } catch (error) {
                console.error('Error fetching temperature:', error);
                statusTextElement.innerText = 'Connection Error';
            }
        }
        
        // NEW: Function to stop everything
        function stopAll() {
            console.log("10 seconds are up. Stopping.");
            
            // 1. Stop the frontend from asking for new data
            clearInterval(fetchDataInterval);
            fetchDataInterval = null; // Clear the variable
            
            // 2. Tell the backend to stop reading from Arduino
            fetch('/stop', { method: 'POST' });
            
            // 3. Update the UI to show the final state
            statusTextElement.innerText = 'Stopped. Final reading displayed.';
        }

        // --- Main Execution on Page Load ---
        window.onload = () => {
            fetchData(); // Get the first reading immediately
            fetchDataInterval = setInterval(fetchData, 2000); // Start the refresh loop
            
            // NEW: Set a timer to stop everything after 10 seconds (10000 milliseconds)
            setTimeout(stopAll, 10000);
        };
    </script>
</body>
</html>